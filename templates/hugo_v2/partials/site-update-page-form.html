{% load tags %}
<form action="/hugo-client-v2/update-page/{{ website_id }}/" id="updatePageForm">
    {% if messages %}
    {% for message in messages %}
        {% if message.tags == "success" %}
        <p class="text-success">
            {{ message }}
        </p>
        {% elif message.tags == "error" %}
        <p class="text-danger">
            {{ message }}
        </p>
        {% endif %}
    {% endfor %}
    {% endif %}
    {% csrf_token %}
    <div class="row mb-3">
        <div class="form-group col-lg-6 mb-3">
            <label>Directory <span class="text-danger">*</span> <small class="text-warning">(Ex: /about/)</small></label>
            <input type="text" name="page" class="form-control p-2" value="{{ page }}" required>
            <input type="hidden" name="page_id" id="route-slug" value="{{ id }}" class="form-control p-2">
            <!--
            <input type="text" id="page_field" name="page_field" class="form-control p-2" oninput="generateSlug()" required>
            <input type="hidden" id="page" name="page" class="form-control p-2" required readonly>
            -->
        </div>
        <div class="form-group col-lg-6 mb-3">
            <label>Child Page <small class="text-warning">(Note: Leave empty if its a single page.)</small></label>
            <input type="text" name="slug" id="route-slug" value="{% if slug != 'None' or slug is not None or slug != ' None ' %} {{ slug }} {% endif %}" class="form-control p-2">
        </div>
        <div class="form-group col-lg-6 mb-3">
            <label>Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control p-2" name="title" value="{{ title }}" required>
        </div>
        <div class="form-group col-lg-6 mb-3">
            <label>Tags <small class="text-warning">(Warning: Separate with ',' or comma.)</small></label>
            <input type="text" name="tags" id="tags" class="form-control p-2" value="{% if tags != 'None' or tags is not None or tags != ' None '%} {{ tags }} {% endif %}">
        </div>
        <div class="form-group col-lg-6 mb-3">
            <label>Categories <small class="text-warning">(Warning: Separate with ',' or comma.)</small></label>
            <input type="text" name="categories" id="categories" value="{% if categories != 'None' or categories is not None or categories != ' None ' %} {{ categories }} {% endif %}" class="form-control p-2">
        </div>
        <div class="form-group col-lg-6 mb-3">
            <label>Keywords <small class="text-warning">(Warning: Separate with ',' or comma.)</small></label>
            <input type="text" name="keywords" id="keywords" value="{% if keywords != 'None' or keywords is not None or keywords != ' None ' %} {{ keywords }} {% endif %}" class="form-control p-2">
        </div>
        <div class="form-group col-lg-12 mb-3">
            <label>Content <span class="text-danger">*</span></label>
            <textarea name="content" id="content" class="form-control p-2">{{ content }}</textarea>
        </div>
        <div class="form-group col-lg-12 mb-3">
            <label>Description</label>
            <textarea class="form-control" name="description">{% if description != 'None' %} {{ description }} {% endif %}</textarea>
        </div>
        <div class="form-group col-lg-4 mb-3">
            <label>Date Published {% json_to_date date_published as date_published %}<span class="text-danger">*</span></label>
            <input type="date" class="form-control p-2" name="date_published" value="{{ date_published|date:'Y-m-d' }}" required>
        </div>
        <div class="form-group col-lg-4 mb-3">
            <label>In Navbar</label>
            <input type="checkbox" name="in_navbar" {% if in_navbar == 'True' %} checked {% endif %}>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-success" id="updateFormBtn">Save</button>
        &nbsp;&nbsp;
        <button class="btn btn-danger" type="button" onclick="cancelPage('{{website_id}}')">Reset</button>
        &nbsp;&nbsp;
        <button class="btn btn-danger" type="button" onclick="deletePageAndRefreshTable('{{website_id}}', '{{id}}')">Delete</button>
    </div>
</form>
<hr>

{% block script %}
<script>
    $('#updateFormBtn').click(function (event) {
		event.preventDefault();
		updatePageFormAndRefreshTable();
	});

    function updatePageFormAndRefreshTable() {
		// Serialize form data
		$('#content').val(CKEDITOR.instances.content.getData())
		const formData = $('#updatePageForm').serialize(); // Serialize form data
		const url = $('#updatePageForm').attr('action');

		Swal.fire({
			title: 'Update Directory?',
			text: 'Please confirm submission',
			icon: 'question',
			showCancelButton: false,
			showLoaderOnConfirm: true,
			allowOutsideClick: false,
			allowEscapeKey: false,
			preConfirm: () => {
				return $.ajax({
					type: 'POST',
					url: url,
					data: formData,
					success: function (response) {
                        const data = JSON.parse(response['data']);
						const website_id = response['website_id']
                        var table = $('#pages-table').DataTable();

                        var targetID = data['id'];
                        var row = table.rows().nodes().to$().filter(function() {
                            return $(this).attr('id') === targetID;
                        });

                        if (row.length > 0) {
                            // Update the data in the cells of the found row
                            row.find('td:eq(0)').text(data['slug'] !== '' ? `${data['page']}${data['slug']}` : data['page']);
                            row.find('td:eq(1)').text(formatDate(data['date_published']));

                            // Update the onclick event and class of a specific cell (e.g., the third cell)
                            var cellIndexToUpdate = 2;
                            var updateCell = row.find('td:eq(' + cellIndexToUpdate + ')');
                            updateCell.attr('onclick', `updatePage('${website_id}', '${data['id']}')`)
                                    .attr('class', 'cursor-pointer text-danger')
                                    .text('Update');
                            
                            // Redraw the DataTable to reflect the changes
                            table.draw();
                        }


						Swal.fire({
							title: 'Success!',
							text: 'Your directory has been updated successfully.',
							icon: 'success'
						});
					},
					error: function (error) {
						// Display an error message
						Swal.fire({
							title: 'Error!',
							text: 'An error occurred while submitting the form.',
							icon: 'error'
						});
						console.error('Error:', error);
					}
				});
			}
		});
	}
    
    $(document).ready(function () {
        CKEDITOR.replace('content');
    });
</script>
{% endblock %}